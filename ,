#!/bin/sh

# check if is sourced
if [ "$0" = "," ]; then
    WD="$PWD"
    cd /
    umount "$WD"
    cd "$WD"
    return
fi

set -e

# remote-exec: Run command on remote server with sshfs and overlayfs

REL=""
WD="$PWD"
while true; do
    OWD="$PWD"
    if [ -f .rmt-config ]; then
        . "$PWD/.rmt-config"
        break
    else
        REL="$(basename "$OWD")/$REL"
        cd ..
        if [ "$PWD" = "$OWD" ]; then
            echo 'remote-exec: rmt-config not found' >&2
            exit 3
        fi
    fi
done
OWD="$(realpath "$OWD")"

cd "$WD"

if [ -z "$RMT_HOST" ]; then
    echo 'remote-exec: RMT_HOST not found' >&2
    exit 2
fi

if [ -z "$RMT_RDIR" ]; then
    RMT_RDIR=".rmt"
fi

T="$(realpath "$(mktemp)")"
finish() {
    rm -f "$T"
}
trap finish EXIT
cat "$OWD/.rmt-config" >"$T"

# check if already mounted

RD="$RMT_RDIR/$(printf '%s' "$OWD" | sha1sum | cut -d ' ' -f 1)"
if mount | grep -qF " on $OWD type fuse.sshfs"; then
    true # do nothing
else
    echo "remote-exec: Creating remote dir $RD" >&2
    ssh "$RMT_HOST" mkdir -p "$RD"
    echo "remote-exec: Mount remote dir to $OWD by sshfs" >&2
    sshfs "$RMT_HOST:$RD" "$OWD"
    echo "remote-exec: Restore $OWD/.rmt-config" >&2
    echo "### WARNING: DO NOT EDIT THIS FILE ###" >"$OWD/.rmt-config"
    if [ -z "$RMT_RSHELL" ]; then
        printf "remote-exec: Detecting login shell ... " >&2
        RMT_RSHELL="$(ssh "$RMT_HOST" echo '$SHELL')"
        echo "$RMT_RSHELL" >&2
        echo "RMT_RSHELL=$RMT_RSHELL" >>"$OWD/.rmt-config"
    fi
    cat "$T" >>"$OWD/.rmt-config"
    echo 'remote-exec: WARNING: You may need to execute "cd ."' >&2
fi

if [ "$#" -eq 0 ]; then
    echo "remote-exec: ssh -Y $RMT_HOST -t /usr/bin/env -C $RD/$REL $RMT_RSHELL" >&2
    exec ssh -Y "$RMT_HOST" -t /usr/bin/env -C "$RD/$REL" "$RMT_RSHELL"
else
    echo "remote-exec: ssh -Y $RMT_HOST /usr/bin/env -C $RD/$REL $*" >&2
    exec ssh -Y "$RMT_HOST" /usr/bin/env -C "$RD/$REL" "$@"
fi
